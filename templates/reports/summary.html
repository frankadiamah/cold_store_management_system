{% extends 'base.html' %}
{% block content %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
  <div class="col-span-2 bg-white dark:bg-slate-900 p-4 rounded shadow-sm border border-slate-200 dark:border-slate-800">
    <h3 class="font-medium mb-3 text-slate-800 dark:text-slate-100">Summary</h3>
    <div class="grid grid-cols-3 gap-3">
      <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded">
        <div class="text-xs text-slate-500 dark:text-slate-400">Total sales</div>
        <div class="text-xl font-semibold text-slate-900 dark:text-slate-100">₵{{ total_sales|floatformat:2 }}</div>
      </div>
      <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded">
        <div class="text-xs text-slate-500 dark:text-slate-400">Expenses</div>
        <div class="text-xl font-semibold text-slate-900 dark:text-slate-100">₵{{ total_expenses|floatformat:2 }}</div>
      </div>
      <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded">
        <div class="text-xs text-slate-500 dark:text-slate-400">Profit</div>
        <div class="text-xl font-semibold text-slate-900 dark:text-slate-100">₵{{ gross_profit|floatformat:2 }}</div>
      </div>
    </div>
{% comment %} added to track credit metrics {% endcomment %}
    
    {% comment %} <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-4"> {% endcomment %}
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
    
  <div class="rounded-xl border border-slate-200 dark:border-slate-800 p-4 bg-slate-50 dark:bg-slate-800">
    <div class="text-xs uppercase text-slate-500 dark:text-slate-400">Credit Sales</div>
    <div class="text-xl font-semibold text-slate-900 dark:text-slate-100">₵{{ credit_sales_total|floatformat:2 }}</div>
  </div>
  <div class="rounded-xl border border-slate-200 dark:border-slate-800 p-4 bg-slate-50 dark:bg-slate-800">
    <div class="text-xs uppercase text-slate-500 dark:text-slate-400">Outstanding Credit</div>
    <div class="text-xl font-semibold text-red-600 dark:text-red-400">₵{{ credit_outstanding|floatformat:2 }}</div>
  </div>
  <div class="rounded-xl border border-slate-200 dark:border-slate-800 p-4 bg-slate-50 dark:bg-slate-800">
    <div class="text-xs uppercase text-slate-500 dark:text-slate-400">Credit Paid</div>
    <div class="text-xl font-semibold text-green-600 dark:text-green-400">
      ₵{{ credit_paid_via_payments|floatformat:2 }}
    </div>
    <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">
      (fallback: ₵{{ credit_paid_via_sales|floatformat:2 }})
    </div>
  </div>
</div>
{% comment %} added to track credit metrics {% endcomment %}

    <div class="mt-6">
      <h4 class="font-medium mb-2 text-slate-800 dark:text-slate-100">Sales vs Expenses (last 30 days)</h4>
      <canvas id="salesChart" width="800" height="300"></canvas>
    </div>

    <div class="mt-6">
      <h4 class="font-medium mb-2 text-slate-800 dark:text-slate-100">Best selling</h4>
      <ul class="space-y-2">
        {% for b in best_selling %}
          <li class="flex justify-between text-slate-700 dark:text-slate-200">{{ b.product__name }} <span class="text-slate-600 dark:text-slate-400">{{ b.qty }}</span></li>
        {% empty %}
          <li class="text-slate-500 dark:text-slate-400">No sales yet</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <aside class="bg-white dark:bg-slate-900 p-4 rounded shadow-sm border border-slate-200 dark:border-slate-800">
    <h4 class="font-medium text-slate-800 dark:text-slate-100">Exports</h4>
    <div class="mt-3">
      <a href="{% url 'export_sales_csv' %}" class="block px-3 py-2 border border-slate-200 dark:border-slate-800 rounded mb-2 text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-800">Download sales CSV</a>
      <a href="{% url 'export_sales_excel' %}" class="block px-3 py-2 border border-slate-200 dark:border-slate-800 rounded mb-2 text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-800">Download sales Excel</a>
      <a href="{% url 'export_sales_pdf' %}" class="block px-3 py-2 border border-slate-200 dark:border-slate-800 rounded mb-2 text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-800">Download sales PDF</a>
    </div>
  </aside>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  async function loadChart(){
    const resp = await fetch("{% url 'chart_sales_vs_expenses' %}");
    const data = await resp.json();
    const ctx = document.getElementById('salesChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.labels,
        datasets: [
          { label: 'Sales', data: data.sales, tension: 0.3, fill: false },
          { label: 'Expenses', data: data.expenses, tension: 0.3, fill: false }
        ]
      },
      options: {
        responsive: true,
        interaction: {mode: 'index', intersect: false},
        scales: { y: { beginAtZero: true } }
      }
    });
  }
  loadChart();
</script>
{% endblock %}
